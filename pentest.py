#import pysolr
import subprocess
#from wappalyzer import Wappalyzer
import json
import builtwith
import nmap
import time
"""
solr = pysolr.Solr('http://192.168.5.16:8983/solr/ExploitDB', timeout=60)
result = solr.search("cve:CVE-2017-0001")
print result.hits
"""
start=time.time()
site = 'https://evaba.com.hr'
try:
    process = subprocess.Popen(['wad', '-u', site], stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
    response=json.loads(process.stdout.read())
    #w=Wappalyzer()
    #data=w.analyze(site)
    collection={}
    for dic in response[response.keys()[0]]:
        if dic["app"].lower() in collection:
            continue
        collection[dic["app"].lower()]=''
        if dic["ver"]!=None:
            collection[dic["app"].lower()]=dic["ver"]
    """
    for key in data.keys():
        if key.lower() in collection:
            if collection[key.lower()]=='' and data[key]["version"]!='':
                collection[key.lower()]=data[key]["version"]
        else:
            collection[key.lower()] = data[key]["version"]
    """
    website=builtwith.parse(site)
    for key in website.keys():
        for item in website[key]:
            if item.lower() not in collection:
                collection[item.lower()]=""

    nm = nmap.PortScanner()
    if (site[0:5]=="https"):
        nm.scan(site[8:], arguments='-sV -A -T4')
    elif (site[0:5]=="http:"):
        nm.scan(site[7:], arguments='-sV -A -T4')
    for ip in nm.all_hosts():
        for key in nm[ip]['tcp'].keys():
            name = nm[ip]['tcp'][key]['product']
            if name.lower() in collection:
                if collection[name.lower()] != '':
                    collection[name.lower()]=nm[ip]['tcp'][key]['version'].lower()
            else:
                collection[name.lower()]=nm[ip]['tcp'][key]['version'].lower()
except Exception as e:
    print e
print time.time()-start
